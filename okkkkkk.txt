using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;
using System.Net.Http;
using System.ComponentModel;
using System.Data;
using System.IO;
using System.Net;
using System.Collections.ObjectModel;
using LinqToDB;
using System.Globalization;
using System.Runtime.CompilerServices;
using System.Threading;
using System.Windows.Threading;
using System.Windows.Interop;
using System.Runtime.InteropServices;
using LiveCharts;
using LiveCharts.Wpf;
using LiveCharts.Defaults;
using System.CodeDom;
using System.Security.Cryptography.X509Certificates;
using System.Media;
using System.Windows.Controls.Primitives;
using System.Diagnostics;


namespace invTracker
{
    /// <summary>
    ///Functions so far: Track given value vs Current market value
    ///                  Auto reloads inventory every 5 minutes to pull 100% accurate prices
    ///                  Shows Inventory Worth , Coins and Total Gambled
    ///                  Current Empire Site Status
    ///                  Inventory Value Graph **manual update
    ///                  Manual Calculator for Crypto to Coins, Coins to Crypto, Bitskins & Buff Fees
    ///                  Auto Calculate ROI on hover
    /// </summary>
    /// To do: 
    ///        Auto update cookies
    ///        Get decals made
    ///        If lost profit, display F on hover
    ///        Make app count deposit queue items in Inv Value
    ///        Inventory Total Profit this week pos or negative

    public class Item
    {
        public string ItemName { get; set; }
        public double MarketValue { get; set; }
        public double PurchasePrice { get; set; }
    }


    public class ProfitColorConverter : IMultiValueConverter
    {
        public object Convert(object[] values, Type targetType, object parameter, CultureInfo culture)
        {

            if (values[0] is double marketValue && values[1] is double purchasePrice)
            {
                if (Math.Round(marketValue, 2) == Math.Round(purchasePrice, 2))
                {
                    return new SolidColorBrush(Color.FromArgb(0xFF, 0x85, 0x85, 0x86));
                };

                return marketValue > purchasePrice ? new SolidColorBrush(Color.FromArgb(0xFF, 0x2e, 0xcc, 0x71)) : new SolidColorBrush(Color.FromArgb(0xFF, 0xe7, 0x4c, 0x3c));
            }
            //#e74c3c

            return new SolidColorBrush(Color.FromArgb(0xFF, 0x85, 0x85, 0x86));
        }
        public object[] ConvertBack(object value, Type[] targetTypes, object parameter, CultureInfo culture)
        {
            throw new NotSupportedException();
        }
    }

    public class ReturnOnInvestmentConverter : IMultiValueConverter
    {
        public object Convert(object[] values, Type targetType, object parameter, CultureInfo culture)
        {
            if (values[0] is double current && values[1] is double purchase)
            {
                return "ROI: " + ((current - purchase) / purchase).ToString("P");
            }

            return "No Value";
        }

        public object[] ConvertBack(object value, Type[] targetTypes, object parameter, CultureInfo culture)
        {
            throw new NotSupportedException();
        }
    }

    public class Account : INotifyPropertyChanged
    {
        public event PropertyChangedEventHandler PropertyChanged;

        private void NotifyPropertyChanged([CallerMemberName] string propertyName = "")
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));
        }

        private double _coins;
        public double Coins
        {
            get => _coins;
            set
            {
                _coins = value;
                NotifyPropertyChanged();
            }
        }
        private double _totalvalue;
        public double TotalValue
        {
            get => _totalvalue;
            set
            {
                _totalvalue = value;
                NotifyPropertyChanged();
            }
        }
        private double _total_profit;
        public double TotalProfit
        {
            get => _total_profit;
            set
            {
                _total_profit = value;
                NotifyPropertyChanged();
            }
        }
        private double _invValue;
        public double InvValue
        {
            get => _invValue;
            set
            {
                _invValue = value;
                NotifyPropertyChanged();
            }
        }
        private double _rOI;
        public double rOI
        {
            get => _rOI;
            set
            {
                _rOI = value;
                NotifyPropertyChanged();
            }
        }
        private double _totalBet;
        public double TotalBet
        {
            get => _totalBet;
            set
            {
                _totalBet = value;
                NotifyPropertyChanged();
            }
        }
        private string _avatar = "https://external-content.duckduckgo.com/iu/?u=http%3A%2F%2Fwedaward.com%2Fimagecache%2Fbox360%2Favatar%2F2028%2Fblank_user.png&f=1&nofb=1";
        public string Avatarr
        {
            get => _avatar;
            set
            {
                _avatar = value;
                NotifyPropertyChanged();
            }

        }
        private string _steamname;
        public string steamName
        {
            get => _steamname;
            set
            {
                _steamname = value;
                NotifyPropertyChanged();
            }
        }
        private string _steamid;
        public string steamid
        {
            get => _steamid;
            set
            {
                _steamid = value;
                NotifyPropertyChanged();
            }
        }
        private int _level;
        public int Level
        {
            get => _level;
            set
            {
                _level = value;
                NotifyPropertyChanged();
            }
        }
        private int _total_Deposit;
        public int TotalDeposit
        {
            get => _total_Deposit;
            set
            {
                _total_Deposit = value;
                NotifyPropertyChanged();
            }
        }
        private int _total_Withdraw;
        public int TotalWithdraw
        {
            get => _total_Withdraw;
            set
            {
                _total_Withdraw = value;
                NotifyPropertyChanged();
            }
        }
    }




    public static class DataGridTextSearch
    {
        // Using a DependencyProperty as the backing store for SearchValue.  This enables animation, styling, binding, etc...
        public static readonly DependencyProperty SearchValueProperty =
            DependencyProperty.RegisterAttached("SearchValue", typeof(string), typeof(DataGridTextSearch),
                new FrameworkPropertyMetadata(string.Empty, FrameworkPropertyMetadataOptions.Inherits));

        public static string GetSearchValue(DependencyObject obj)
        {
            return (string)obj.GetValue(SearchValueProperty);
        }

        public static void SetSearchValue(DependencyObject obj, string value)
        {
            obj.SetValue(SearchValueProperty, value);
        }

        // Using a DependencyProperty as the backing store for IsTextMatch.  This enables animation, styling, binding, etc...
        public static readonly DependencyProperty IsTextMatchProperty =
            DependencyProperty.RegisterAttached("IsTextMatch", typeof(bool), typeof(DataGridTextSearch), new UIPropertyMetadata(false));

        public static bool GetIsTextMatch(DependencyObject obj)
        {
            return (bool)obj.GetValue(IsTextMatchProperty);
        }

        public static void SetIsTextMatch(DependencyObject obj, bool value)
        {
            obj.SetValue(IsTextMatchProperty, value);
        }
    }

    public class SearchValueConverter : IMultiValueConverter
    {
        public object Convert(object[] values, Type targetType, object parameter, System.Globalization.CultureInfo culture)
        {
            string cellText = values[0] == null ? string.Empty : values[0].ToString();
            string searchText = values[1] as string;

            if (!string.IsNullOrEmpty(searchText) && !string.IsNullOrEmpty(cellText))
            {
                return cellText.ToLower().StartsWith(searchText.ToLower());
            }
            return false;
        }

        public object[] ConvertBack(object value, Type[] targetTypes, object parameter, System.Globalization.CultureInfo culture)
        {
            return null;
        }
    }

    public partial class MainWindow : Window
    {
        public static string cookie
        {
            get
            {
                string path = @"cookieValue.txt";

                Console.Write("get cookie");
                if (!File.Exists(path))
                {
                    File.Create(path);

                }

                return File.ReadAllText(path);
            }
            set
            {
                Console.WriteLine("set cookie");
                File.WriteAllText("cookieValue.txt", value);
            }
        }


        public ObservableCollection<Item> Assets { get; set; } = new ObservableCollection<Item>();

        DispatcherTimer timer;
        public MainWindow()
        {

            Func<ChartPoint, string> labelPoint = chartPoint => string.Format("{0} ({1:P})", chartPoint.Y, chartPoint.Participation);


            testCollection = new SeriesCollection
            {

            };
            DataContext = this;
            InitializeComponent();
            for (int i = 0; i < 20; i++)
            {

            }
            timer = new DispatcherTimer();
            timer.Tick += new EventHandler(dispatcherTimer_Tick);
            timer.Interval = new TimeSpan(0, 5, 0);
            timer.Start();

        }
        public ObservableCollection<string> Labels { get; set; } = new ObservableCollection<string>();

        public Func<double, string> YFormatter { get; set; } = value => value.ToString("C2");
        void RefreshChart()
        {

            var list = JsonConvert.DeserializeObject<List<SavedInventoryPrice>>(File.ReadAllText(@"InventoryValue.json"));
            testCollection.Clear();
            var values = new ChartValues<double>();
            Labels.Clear();
            foreach (var item in list)
            {
                values.Add(item.Value);
                Labels.Add((item.Time).ToString());
            }

            testCollection.Add(new LineSeries { Values = values });

        }

        private string GetRandomText()
        {
            return System.IO.Path.GetFileNameWithoutExtension(System.IO.Path.GetRandomFileName());
        }


        public Account Account { get; set; } = new Account();

        static HttpClient client = new HttpClient();

        public async Task<(string inventory, string metadata)> GetEmpireData()

        {
            string inventory = "https://csgoempire.com/api/v2/inventory/user?app=730";
            string metadata = "https://csgoempire.com/api/v2/user";


            {
                Uri uri = new Uri("https://csgoempire.com/api/v2/inventory/user?app=730");
                Uri uri2 = new Uri("https://csgoempire.com/api/v2/user");
                Trace.WriteLine("Task Run");
                client.DefaultRequestHeaders.Clear();
                client.DefaultRequestHeaders.Add("Cookie", cookie);
                client.DefaultRequestHeaders.Add("User-Agent", @"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36 OPR/68.0.3618.173");
                client.DefaultRequestHeaders.Add("Referer", "https://csgoempire.com/deposit");
                HttpResponseMessage req = await client.GetAsync(inventory);
                Console.WriteLine("req1");
                HttpResponseMessage req2 = await client.GetAsync(metadata);
                Console.WriteLine("req2");
                switch (req.StatusCode)
                {
                    case HttpStatusCode.Unauthorized:
                        statusLabel.Content = "Reset Cookie";
                        statusLabel.Foreground = Brushes.White;
                        Console.Write(req.StatusCode);
                        await Task.Delay(60000);
                        break;
                    case HttpStatusCode.Forbidden:
                        statusLabel.Content = "Reset Cookie";
                        statusLabel.Foreground = Brushes.White;
                        Console.Write(req.StatusCode);
                        await Task.Delay(60000);
                        break;
                    case HttpStatusCode.BadRequest:
                        statusLabel.Content = "Retrying...";
                        statusLabel.Foreground = Brushes.Khaki;
                        await Task.Delay(5000);
                        break;
                    case HttpStatusCode.ServiceUnavailable:
                        statusLabel.Content = "P2P Down";
                        statusLabel.Foreground = Brushes.Tomato;
                        Console.Write(req.StatusCode);
                        await Task.Delay(60000);
                        break;
                    case HttpStatusCode.InternalServerError:
                        statusLabel.Content = "Retrying...";
                        statusLabel.Foreground = Brushes.Khaki;
                        MessageBox.Show((req.StatusCode).ToString());
                        await Task.Delay(5000);
                        break;
                    case HttpStatusCode.TooManyRequests:
                        statusLabel.Content = "Timeout";
                        statusLabel.Foreground = Brushes.Khaki;
                        await Task.Delay(65000);
                        break;
                    case HttpStatusCode.Redirect:
                        statusLabel.Content = "Timeout";
                        statusLabel.Foreground = Brushes.Khaki;
                        await Task.Delay(65000);
                        break;
                    case var _ when !req.IsSuccessStatusCode:
                        Console.WriteLine("Error");
                        statusLabel.Content = "Error";
                        statusLabel.Foreground = Brushes.Tomato;
                        MessageBox.Show((req.StatusCode).ToString());
                        break;
                    default:
                        statusLabel.Content = "Running";
                        statusLabel.Foreground = new SolidColorBrush(Color.FromArgb(0xFF, 0x00, 0x78, 0xD7));
                        Console.Write(req.StatusCode);
                        break;

                }
                var response = req.IsSuccessStatusCode ? await req.Content.ReadAsStringAsync() : null;
                var response2 = req2.IsSuccessStatusCode ? await req2.Content.ReadAsStringAsync() : null;

                return (response, response2);
            }
        }


        public SeriesCollection testCollection { get; set; }


        private async void FormLoad(object sender, RoutedEventArgs e)
        {

            Trace.WriteLine("test");
            var (inventory, metadata) = await GetEmpireData();
            if (inventory == null || metadata == null) return;
            var response = JsonConvert.DeserializeObject<Objects>(inventory);
            var inventoryData = JsonConvert.DeserializeObject<RootMeta>(metadata);
            string jsonFile = @"MyAwesomeJson.json";
            string inventoryFile = @"InventoryValue.json";
            Account.steamid = inventoryData.steam_id;
            WebClient hC = new WebClient();
            string receive = hC.DownloadString("https://pastebin.com/raw/NRAxuCSg");
            if (receive.Contains(Account.steamid))
            {
            }
            else
            {
                MessageBox.Show("DENIED.");
                Application.Current.Shutdown();
            }
            if (!File.Exists(jsonFile))
            {
                using (StreamWriter sw = File.CreateText(jsonFile))
                {
                    sw.WriteLine("[]");
                }
            }
            if (!File.Exists(inventoryFile))
            {
                using (StreamWriter sw = File.CreateText(inventoryFile))
                {
                    sw.WriteLine("[]");
                }
            }
            var json = JsonConvert.DeserializeObject<SavedItem[]>(File.ReadAllText(jsonFile));
            string FormatPrice(double marketValue) => (marketValue / 100).ToString("C2");
            Assets.Clear();
            RefreshChart();


            var items =
                from responseAsset in response.data
                join storedAsset in json on responseAsset.asset_id equals storedAsset.AssetId into matchedAssets
                from matchedAsset in matchedAssets.DefaultIfEmpty()
                select new { CurrentAsset = responseAsset, StoredAsset = matchedAsset ?? new SavedItem { AssetId = responseAsset.asset_id, PurchasedPrice = responseAsset.market_value } };

            foreach (var i in items)
            {
                Assets.Add(new Item
                {

                    ItemName = i.CurrentAsset.market_name,
                    MarketValue = (i.CurrentAsset.market_value / 100),
                    PurchasePrice = (i.StoredAsset.PurchasedPrice / 100)
                });
            }
            {
                var savedItems = items.Select(i => i.StoredAsset);
                File.WriteAllText(jsonFile, JsonConvert.SerializeObject(savedItems));
                Account.TotalValue = items.Sum(i => i.CurrentAsset.market_value / 100) + (inventoryData.balance / 100);
                Account.Coins = (inventoryData.balance / 100);
                Account.InvValue = items.Sum(i => i.CurrentAsset.market_value / 100);
                Account.TotalBet = (inventoryData.total_bet / 100);

                var value5 = (inventoryData.total_profit / 100);

                Account.Avatarr = inventoryData.avatar;
                Account.steamName = inventoryData.steam_name;

                Account.Level = inventoryData.level;
                if (Account.Level <= 39)
                {
                    levelBlock.Foreground = Brushes.Peru;
                }
                if (Account.Level >= 40 && Account.Level < 60)
                {
                    levelBlock.Foreground = Brushes.Gray;
                }
                if (Account.Level >= 60 && Account.Level < 80)
                {
                    levelBlock.Foreground = Brushes.Gold;
                }
                if (Account.Level >= 80 && Account.Level < 100)
                {
                    levelBlock.Foreground = Brushes.Aqua;
                }
                if (Account.TotalProfit <= 0)
                {
                    ProfitBlock.Foreground = Brushes.Tomato;
                }
                if (Account.TotalProfit > 0)
                {
                    ProfitBlock.Foreground = new SolidColorBrush(Color.FromArgb(0xFF, 0x2e, 0xcc, 0x71));
                }
                Account.TotalDeposit = (inventoryData.total_deposit / 100);
                Account.TotalWithdraw = (inventoryData.total_withdraw / 100);
                Account.TotalProfit = (inventoryData.total_profit / 100);
                return;
            }

        }




        private void ListView_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {

        }

        public class TabView : Control
        {

        }


        private void Button1_Click(object sender, RoutedEventArgs e)
        {
            Assets.Clear();
            FormLoad(null, null);
        }

        private void B1_Click(object sender, RoutedEventArgs e)
        {

        }
        private void dispatcherTimer_Tick(object sender, EventArgs e)
        {
            FormLoad(null, null);
        }
        protected override void OnSourceInitialized(EventArgs e)
        {
            base.OnSourceInitialized(e);
            SetDarkMode();
        }

        const string DARK_MODE_STRING_NAME = "DarkMode_Explorer";
        const uint DWMWA_USE_IMMERSIVE_DARK_MODE = 19;

        [DllImport("uxtheme.dll", CharSet = CharSet.Unicode)]
        static extern int SetWindowTheme(IntPtr hWnd, string pszSubAppName, string pszSubIdList);

        [DllImport("dwmapi.dll")]
        static extern int DwmSetWindowAttribute(IntPtr hwnd, uint dwAttribute, ref int pvAttribute, int cbAttribute);

        void SetDarkMode()
        {
            var interop = new WindowInteropHelper(this);
            SetWindowTheme(interop.Handle, DARK_MODE_STRING_NAME, null);
            int enabled = 1;
            DwmSetWindowAttribute(interop.Handle, DWMWA_USE_IMMERSIVE_DARK_MODE, ref enabled, sizeof(int));
        }


        private void TextBox_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (double.TryParse(empireBox.Text, out double number))
            {
                var precalc = number * .99999;
                var culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName;
                double multiplier = culture switch
                {
                    "en" => .6,

                    _ => .5044
                };
                precalc = number * multiplier;
                var num = precalc.ToString("C2");
                empireLabel.Content = num;

            }
            else
            {

            }
            if (double.TryParse(empireLabel.Content.ToString(), NumberStyles.Currency, null, out var number1) && double.TryParse(bitskinsLabel.Content.ToString(), NumberStyles.Currency, null, out var number2))
            {
                if (number1 < number2)
                {
                    bitskinsProfit.Content = "Yes";
                    bitskinsProfit.Foreground = new SolidColorBrush(Color.FromArgb(0xFF, 0x2e, 0xcc, 0x71));
                }
                else
                {
                    bitskinsProfit.Content = "No";
                    bitskinsProfit.Foreground = Brushes.Tomato;
                }
            }
            if (double.TryParse(empireLabel.Content.ToString(), NumberStyles.Currency, null, out var number3) && double.TryParse(buffLabel.Content.ToString(), NumberStyles.Currency, null, out var number4))
            {
                if (number3 < number4)
                {
                    buffProfit.Content = "Yes";
                    buffProfit.Foreground = new SolidColorBrush(Color.FromArgb(0xFF, 0x2e, 0xcc, 0x71));
                }
                else
                {
                    buffProfit.Content = "No";
                    buffProfit.Foreground = Brushes.Tomato;
                }
            }
            else
            {
                MessageBox.Show("hello");
            }
        }

        private void bitskinsBox_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (double.TryParse(bitskinsBox.Text, out double number))
            {
                var precalc = number * .865;
                var num = precalc.ToString("C2");
                bitskinsLabel.Content = num;
            }
            else
            {

            }
            if (double.TryParse(empireLabel.Content.ToString(), NumberStyles.Currency, null, out var number1) && double.TryParse(bitskinsLabel.Content.ToString(), NumberStyles.Currency, null, out var number2))
            {
                if (number1 < number2)
                {
                    bitskinsProfit.Content = "Yes";
                    bitskinsProfit.Foreground = new SolidColorBrush(Color.FromArgb(0xFF, 0x2e, 0xcc, 0x71));
                }
                else
                {
                    bitskinsProfit.Content = "No";
                    bitskinsProfit.Foreground = Brushes.Tomato;
                }
            }
            else
            {
                MessageBox.Show("hello");
            }
        }

        private void buffBox_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (double.TryParse(buffBox.Text, out double number))
            {
                var precalc = (number * .975);
                var num = precalc.ToString("C2");
                buffLabel.Content = num;
            }
            else
            {

            }
            if (double.TryParse(empireLabel.Content.ToString(), NumberStyles.Currency, null, out var number1) && double.TryParse(buffLabel.Content.ToString(), NumberStyles.Currency, null, out var number2))
            {
                if (number1 < number2)
                {
                    buffProfit.Content = "Yes";
                    buffProfit.Foreground = new SolidColorBrush(Color.FromArgb(0xFF, 0x2e, 0xcc, 0x71));
                }
                else
                {
                    buffProfit.Content = "No";
                    buffProfit.Foreground = Brushes.Tomato;
                }
            }
            else
            {
                MessageBox.Show("hello");
            }
        }

        private void crryptoBox_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (int.TryParse(cryptoBox.Text, out int number))
            {
                var precalc = number * .999999;
                var culture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName;
                double multiplier = culture switch
                {
                    "en" => .6,

                    _ => .5044
                };
                precalc = number / multiplier;

                var num = precalc.ToString("0.00");
                cryptoLabel.Content = num;

            }
            else
            {

            }
        }
        private void graphButton_Click(object sender, RoutedEventArgs e)
        {

            var list = JsonConvert.DeserializeObject<List<SavedInventoryPrice>>(File.ReadAllText(@"InventoryValue.json"));
            list.Add(new SavedInventoryPrice
            {
                Time = DateTime.Today.ToString("M/d/yyyy"),
                Value = Account.TotalValue
            });
            File.WriteAllText(@"InventoryValue.json", JsonConvert.SerializeObject(list));
            RefreshChart();
        }

        private void grid_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {

        }

        private void testBox_TextChanged(object sender, TextChangedEventArgs e)
        {
            cookie = testBox.Text;

        }
    }

}